<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard - HustlerShop (Appwrite)</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="admin-body">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i data-lucide="shopping-bag"></i>
                    </div>
                    <span class="logo-text">HustlerShop</span>
                </div>
            </div>

            <nav class="sidebar-content">
                <div class="sidebar-nav">
                    <a href="dashboard.html" class="nav-item active">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="cart.html" class="nav-item">
                        <i data-lucide="shopping-cart"></i>
                        <span>Cart</span>
                        <span class="badge badge-primary hidden" data-cart-badge>0</span>
                    </a>
                    <a href="orders.html" class="nav-item">
                        <i data-lucide="package"></i>
                        <span>Orders</span>
                    </a>
                    <a href="wishlist.html" class="nav-item">
                        <i data-lucide="heart"></i>
                        <span>Wishlist</span>
                    </a>
                    <a href="profile.html" class="nav-item">
                        <i data-lucide="user"></i>
                        <span>Profile</span>
                    </a>
                </div>

                <div class="sidebar-footer-nav">
                    <button id="logoutBtn" type="button"
                        class="nav-item w-full bg-transparent border-none text-left cursor-pointer">
                        <i data-lucide="log-out"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile-mini">
                    <div class="user-avatar">
                        <img src="https://ui-avatars.com/api/?name=Customer&background=000&color=fff"
                            alt="Customer">
                    </div>
                    <div class="user-info">
                        <span class="user-name" data-user-name>Customer</span>
                        <span class="user-role">Cliente</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button type="button" class="sidebar-toggle" aria-label="Toggle menu">
                        <i data-lucide="menu"></i>
                    </button>
                    <div class="search-container">
                        <i data-lucide="search"></i>
                        <input type="text" placeholder="Search products...">
                    </div>
                </div>

                <div class="topbar-right">
                    <button type="button" class="icon-btn relative" aria-label="View notifications">
                        <i data-lucide="bell"></i>
                        <span class="notification-dot"></span>
                    </button>
                    
                    <button type="button" class="icon-btn" aria-label="Toggle theme">
                        <i data-lucide="moon"></i>
                    </button>

                    <div class="user-dropdown">
                        <button type="button" class="user-menu-trigger" aria-label="User menu">
                            <div class="user-avatar">
                                <img src="https://ui-avatars.com/api/?name=Customer&background=000&color=fff"
                                    alt="User">
                            </div>
                            <i data-lucide="chevron-down" class="dropdown-icon"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <div class="content-header">
                    <h1 class="page-title">Welcome back!</h1>
                    <p class="page-description">Here's what's happening with your orders today.</p>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary-100 text-primary-600">
                            <i data-lucide="package"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-title">Total Orders</h3>
                            <p class="stat-value" id="totalOrders">0</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon bg-success-100 text-success-600">
                            <i data-lucide="check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-title">Completed</h3>
                            <p class="stat-value" id="completedOrders">0</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon bg-warning-100 text-warning-600">
                            <i data-lucide="clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-title">Pending</h3>
                            <p class="stat-value" id="pendingOrders">0</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon bg-info-100 text-info-600">
                            <i data-lucide="heart"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-title">Wishlist</h3>
                            <p class="stat-value" id="wishlistCount">0</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Orders</h2>
                        <a href="orders.html" class="btn btn-ghost btn-sm">View All</a>
                    </div>
                    <div class="card-content">
                        <div id="recentOrders" class="space-y-4">
                            <!-- Orders will be loaded here -->
                            <div class="text-center py-8 text-secondary">
                                <i data-lucide="package" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                                <p>Loading your orders...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Featured Products -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Featured Products</h2>
                        <a href="#" class="btn btn-ghost btn-sm">View All</a>
                    </div>
                    <div class="card-content">
                        <div id="featuredProducts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Products will be loaded here -->
                            <div class="text-center py-8 text-secondary col-span-full">
                                <i data-lucide="shopping-bag" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                                <p>Loading featured products...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Import Appwrite modules
        import { initAuth, requireAuth, signOut, getCurrentUserProfile } from '../assets/js/core/auth-appwrite.js';
        import { initSidebar } from '../assets/js/components/sidebar.js';
        import { initTopbar } from '../assets/js/components/topbar.js';
        import { ordersAPI, productsAPI, wishlistAPI } from '../assets/js/core/api-appwrite.js';
        import { ORDER_STATUS } from '../assets/js/core/appwrite.js';
        import { showToast } from '../assets/js/components/toast.js';
        
        // Initialize Lucide icons
        lucide.createIcons();

        // Dashboard state
        let dashboardData = {
            orders: [],
            products: [],
            wishlist: [],
            stats: {
                totalOrders: 0,
                completedOrders: 0,
                pendingOrders: 0,
                wishlistCount: 0
            }
        };

        // Initialize dashboard
        async function initDashboard() {
            try {
                // Initialize authentication and check if user is logged in
                await initAuth();
                if (!await requireAuth()) return;

                // Initialize UI components
                initSidebar();
                initTopbar();

                // Load dashboard data
                await Promise.all([
                    loadUserStats(),
                    loadRecentOrders(),
                    loadFeaturedProducts()
                ]);

                // Update UI
                updateStatsDisplay();
                updateRecentOrdersDisplay();
                updateFeaturedProductsDisplay();

                // Re-initialize Lucide icons after dynamic content
                lucide.createIcons();

                console.log('✅ Dashboard loaded successfully with Appwrite');
            } catch (error) {
                console.error('❌ Dashboard initialization error:', error);
                showToast('Failed to load dashboard', 'error');
            }
        }

        // Load user statistics
        async function loadUserStats() {
            try {
                // Load orders
                const ordersResult = await ordersAPI.getUserOrders();
                if (ordersResult.success) {
                    dashboardData.orders = ordersResult.data;
                    
                    // Calculate stats
                    dashboardData.stats.totalOrders = dashboardData.orders.length;
                    dashboardData.stats.completedOrders = dashboardData.orders.filter(
                        order => order.status === ORDER_STATUS.DELIVERED
                    ).length;
                    dashboardData.stats.pendingOrders = dashboardData.orders.filter(
                        order => order.status === ORDER_STATUS.PENDING || order.status === ORDER_STATUS.CONFIRMED
                    ).length;
                }

                // Load wishlist
                const wishlistResult = await wishlistAPI.getUserWishlist();
                if (wishlistResult.success) {
                    dashboardData.wishlist = wishlistResult.data;
                    dashboardData.stats.wishlistCount = dashboardData.wishlist.length;
                }

            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Load recent orders
        async function loadRecentOrders() {
            try {
                const result = await ordersAPI.getUserOrders();
                if (result.success) {
                    // Get last 5 orders
                    dashboardData.orders = result.data.slice(0, 5);
                }
            } catch (error) {
                console.error('Error loading recent orders:', error);
            }
        }

        // Load featured products
        async function loadFeaturedProducts() {
            try {
                const result = await productsAPI.getAll({ 
                    inStock: true,
                    limit: 6
                });
                if (result.success) {
                    dashboardData.products = result.data;
                }
            } catch (error) {
                console.error('Error loading featured products:', error);
            }
        }

        // Update statistics display
        function updateStatsDisplay() {
            document.getElementById('totalOrders').textContent = dashboardData.stats.totalOrders;
            document.getElementById('completedOrders').textContent = dashboardData.stats.completedOrders;
            document.getElementById('pendingOrders').textContent = dashboardData.stats.pendingOrders;
            document.getElementById('wishlistCount').textContent = dashboardData.stats.wishlistCount;
        }

        // Update recent orders display
        function updateRecentOrdersDisplay() {
            const container = document.getElementById('recentOrders');
            
            if (dashboardData.orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-secondary">
                        <i data-lucide="package" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p>No orders yet</p>
                        <a href="#" class="btn btn-primary btn-sm mt-4">Start Shopping</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = dashboardData.orders.map(order => `
                <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="package" class="w-6 h-6 text-primary-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium">Order #${order.$id.slice(-8)}</h4>
                            <p class="text-sm text-secondary">${new Date(order.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="badge badge-${getStatusColor(order.status)}">${order.status}</span>
                        <p class="font-medium mt-1">${formatCurrency(order.total)}</p>
                    </div>
                </div>
            `).join('');
        }

        // Update featured products display
        function updateFeaturedProductsDisplay() {
            const container = document.getElementById('featuredProducts');
            
            if (dashboardData.products.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-secondary col-span-full">
                        <i data-lucide="shopping-bag" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p>No products available</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = dashboardData.products.map(product => `
                <div class="card hover:shadow-lg transition-shadow cursor-pointer">
                    <div class="aspect-square bg-gray-100 rounded-lg mb-4 overflow-hidden">
                        <img src="${product.image_url || 'https://via.placeholder.com/300'}" 
                             alt="${product.name}" 
                             class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-medium mb-2">${product.name}</h3>
                    <p class="text-sm text-secondary mb-3 line-clamp-2">${product.description || 'No description available'}</p>
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-lg">${formatCurrency(product.price)}</span>
                        <button class="btn btn-primary btn-sm" onclick="addToCart('${product.$id}')">
                            <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function getStatusColor(status) {
            switch (status) {
                case ORDER_STATUS.DELIVERED: return 'success';
                case ORDER_STATUS.CONFIRMED: return 'primary';
                case ORDER_STATUS.PREPARING: return 'warning';
                case ORDER_STATUS.DELIVERING: return 'info';
                default: return 'secondary';
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('pt-MZ', {
                style: 'currency',
                currency: 'MZN'
            }).format(amount || 0);
        }

        // Add to cart function
        window.addToCart = async function(productId) {
            try {
                const result = await cartAPI.addItem(productId, 1);
                if (result.success) {
                    showToast('Product added to cart', 'success');
                    // Update cart badge
                    const cartBadge = document.querySelector('[data-cart-badge]');
                    if (cartBadge) {
                        cartBadge.textContent = parseInt(cartBadge.textContent) + 1;
                        cartBadge.classList.remove('hidden');
                    }
                } else {
                    showToast('Failed to add to cart', 'error');
                }
            } catch (error) {
                console.error('Add to cart error:', error);
                showToast('Failed to add to cart', 'error');
            }
        };

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut();
        });

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>

</html>
